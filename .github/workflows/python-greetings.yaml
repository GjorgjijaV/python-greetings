name: Python Microservice Greetings CI/CD
on:
    push:
        branches:
            - main
    workflow_dispatch:
jobs:
    build-docker-image:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/build
              with:
                docker_hub_username: ${{ secrets.DOCKER_HUB_USERNAME }}
                docker_hub_access_token: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
    deploy-to-dev:
        runs-on: ubuntu-latest
        needs: [build-docker-image]
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/deploy
              with:
                environment: 'dev'

    tests-on-dev:
        runs-on: ubuntu-latest
        needs: [deploy-to-dev]
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/test
              with:
                environment: 'dev'
            # - name: Starting docker service with latest image
            #   run: docker compose -f docker-compose.yml up -d greetings-app-dev || echo "Container STARTED on DEV Environment"
            # - name: Verify container is running by filtering running containers
            #   run: docker ps --filter "name=greetings-app-dev"
    deploy-to-stg:
        runs-on: ubuntu-latest
        needs: [tests-on-dev]
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/deploy
              with:
                environment: 'stg'
    tests-on-stg:
        runs-on: ubuntu-latest
        needs: [deploy-to-stg]
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/test
              with:
                environment: 'stg'
            # - name: Starting docker service with latest image
            #   run: docker compose -f docker-compose.yml up -d greetings-app-stg || echo "Container STARTED on STG Environment"
            # - name: Verify container is running by filtering running containers
            #   run: docker ps --filter "name=greetings-app-stg"
    deploy-to-prod:
        runs-on: ubuntu-latest
        needs: [tests-on-stg]
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/deploy
              with:
                environment: 'prod'
    tests-on-prod:
        runs-on: ubuntu-latest
        needs: [deploy-to-prod]
        steps:
            - uses: actions/checkout@v3
            - uses: ./.github/actions/test
              with:
                environment: 'prod'
            # - name: Starting docker service with latest image
            #   run: docker compose -f docker-compose.yml up -d greetings-app-prod || echo "Container STARTED on PROD Environment"
            # - name: Verify container is running by filtering running containers
            #   run: docker ps --filter "name=greetings-app-prod"